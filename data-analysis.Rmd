---
title: Traffic Data Analysis
output: html_document
---

```{r}
library(dplyr)
library(lubridate)
library(stringr)
library(corrplot)
library(caret)
```

## Reading Data

```{r}
data = read.csv("all-semi-unique.csv")
dim(data)
names(data)
str(data)
summary(data)
```

Having a look on the first few rows of the data.

```{r}
head(data)
```

## Cleaning Data

### Processing Columns

Removing advertisements columns.

```{r}
data <- data %>% select(-starts_with("ad."))
ncol(data)
names(data)
```

Removing road images, colors and rode report images.

```{r}
data <- subset(data, select = -c(rd.img, rd.cl, rd.rp.rpImg, rd.rp.img))
ncol(data)
names(data)
```

### Processing Rows

Checking number of duplicate rows.

```{r}
nrow(data) - nrow(unique(data))
```

Removing rows with same comment id.

```{r}
data <- data %>% distinct(rd.rp.cmid)
nrow(data)
```

## Feature Engineering

Checking proportion of N/A values.

```{r}
sum(is.na(data)) / nrow(data) / ncol(data)

barplot(sapply(data, function(col) sum(is.na(col))))
```

### Feature Removal

Checking columns with constant features and printing their names.

```{r}
col_ct = sapply(data, function(x) length(unique(x)))
length(col_ct[col_ct == 1])
names(col_ct[col_ct == 1])
```

Removing constant-feature columns.

```{r}
data = data[, !names(data) %in% names(col_ct[col_ct == 1])]
ncol(data)
names(data)
```

Finding featues with high correlation values.

```{r}
cor_feats = c("rd.ri", "rd.stid", "rd.new", "rd.strq", "rd.cmrq", "rd.rp.stid", "rd.rp.cmid")
cor_mat = cor(data[, cor_feats], use = "complete")
corrplot(method = "shade", cor_mat)

cor_threshold = 0.6
high_cor <- findCorrelation(cor_mat, cutoff = cor_threshold)
cor_feats[high_cor]
```

### Feature Creation

Formatting `crawl_date` into a proper `datetime` format and changing the timezone from `UTC` to `Egypt`.

```{r}
data$formatted_crawl_date <- as.POSIXct(data$crawl_date, format = "%a %b %d %T UTC %Y", tz = "UTC")
data$formatted_crawl_date <- as.POSIXct(c(data$formatted_crawl_date), tz = "Egypt")
head(data$crawl_date)
head(data$formatted_crawl_date)
str(data$formatted_crawl_date)
```

Adding `report_date` to the data frame.

```{r}
data$report_date <- data$formatted_crawl_date - hours(data$rd.rp.hr) - minutes(data$rd.rp.mn)
head(data$report_date)
```

Adding `road_date` to the data frame.

```{r}
data$road_date <- data$formatted_crawl_date - hours(data$rd.hr) - minutes(data$rd.mn)
head(data$road_date)
```

Finding road delimiters.

```{r}
nrow(data) - length(which(grepl(";", data$rd.nm))) - length(which(grepl("-", data$rd.nm))) - length(which(grepl("/", data$rd.nm)))

missed_delimiters <- which(!grepl(";", data$rd.nm) & !grepl("-", data$rd.nm) & !grepl("/", data$rd.nm))

unique(data[missed_delimiters,]$rd.nm)
```

Splitting road names into areas and roads.

```{r}
data <- data %>% mutate(
  area = ifelse(grepl(";", rd.nm),
                str_split_fixed(rd.nm, ";", 2)[, 1],
                ifelse(grepl("-", rd.nm),
                       str_split_fixed(rd.nm, "-", 2)[, 1],
                       ifelse(grepl("/", rd.nm),
                              str_split_fixed(rd.nm, "/", 2)[, 1],
                              rd.nm)))
  
  ,
  
  road = ifelse(grepl(";", rd.nm),
                str_split_fixed(rd.nm, ";", 2)[, 2],
                ifelse(grepl("-", rd.nm),
                       str_split_fixed(rd.nm, "-", 2)[, 2],
                       ifelse(grepl("/", rd.nm),
                              str_split_fixed(rd.nm, "/", 2)[, 2],
                              NA)))
)
```

Getting road directions.

```{r}
data <- data %>% mutate(
  road_from = ifelse(is.na(road), NA, str_split_fixed(road, " To ", 2)[, 1])
  
  ,
  
  road_to = ifelse(is.na(road), NA, str_split_fixed(road, " To ", 2)[, 2])
)
```

## Exploratory Data Analysis

### Identify Metrics and Dimensions

**Dimensions**:

* `crawl_date`: The crawl date and time for a report. It was used to get `formatted_crawl_date`.

* `rd.nm`: The road name. It was used to get the `area` name, `road_from` and `road_to` directions.

* `rd.ri`:
```{r}
length(unique(data$rd.nm))
ri <- data %>% group_by(rd.nm) %>% summarize(unique_ri = n_distinct(rd.ri))
length(which(ri$unique_ri > 1))
ri[which(ri$unique_ri > 1), ]
```

From the above results, `ri` can be considered a road id.

* `rd.stid`: A number corresponding to the status of a road.

* `rd.hr`: The hour value of the last update of a road.

* `rd.mn`: The minute value of the last update of a road.

* `rd.new`:
```{r}
length(unique(data$rd.new))
unique(data$rd.new)
length(which(data$rd.new == 0))
length(which(data$rd.new == 1))
```

It might be to indicate the state of new reports for a given road.

* `rd.strq` and `rd.cmrq`: From the correlation plot, it is evident that there is a strong (negative) correlation between `rd.strq` and `rd.cmrq`. Further inspecting the relation between the 2 columns:

```{r}
length(unique(data$rd.strq))
cmrq <- data %>% group_by(rd.strq) %>% summarize(unique_cmrq = n_distinct(rd.cmrq), mean_cmrq = mean(rd.cmrq))
cmrq[1:2, ]
```

They might indicate the a certain state for status requests and comment requests.

* `rd.rp.nm`: The user name of a report.

* `rd.rp.fullnm`: The user full name of a report.

* `rd.rp.hr`: The hour value passed since the publish of the report.

* `rd.rp.mn`: The minute value passed since the public of the report.

* `rd.rp.stid`: The status of a report.

* `rd.rp.cm`: The comment published in a report.

* `rd.rp.cmid`: The id of a comment published in a report.

* `formatted_crawl_date`: The `crawl_date` in local time. It was used to get `report_date`.

* `report_date`: The date and time for a report. It is better than the amount of time passed since the report publish.

* `road_date`: The date and time for a road last update. It is better than the amount of time passed since the road update.

* `area`: The area name of a report.

* `road`: The road name of a report.

* `road_from`: The *from* direction of a road report.

* `road_to`: The *to* direction of a road report. `area`, `road_from` and `road_to` combination is the result of `rd.nm` decomposition. It is better using this decomposition to have a better look on road reports.

*Useful Dimensions*:

* `rd.stid`
* `rd.rp.nm`
* `rd.rp.fullnm`
* `rd.rp.stid`
* `rd.rp.cm`
* `report_date`
* `road_date`
* `area`
* `road_from`
* `road_to`

Selecting only these columns for the data

```{r}
data <- data %>% subset(select = c(rd.stid, rd.rp.nm, rd.rp.fullnm, rd.rp.stid, rd.rp.cm, report_date, road_date, area, road_from, road_to))
ncol(data)
names(data)
head(data)
```

**Possible Metrics**:

* Users preferences for stating user names and full names.
* The impact of automated GPS reportings.
* User statistics.
* Area and road statuses throughout the day.
* Comments statistics.
* Area and road reporting times.
* Area and road traffic jams.
* Area and road reporting densities.

### Descriptive Statistics

```{r}
length(unique(data$rd.stid))
sort(unique(data$rd.stid))
```

## Inferential Data Analysis

### Parameter Inference (Confidence Intervals)