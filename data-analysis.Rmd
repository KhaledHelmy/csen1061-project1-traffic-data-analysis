---
title: Traffic Data Analysis
output: html_document
---

```{r}
library(dplyr)
library(lubridate)
library(stringr)
```

## Reading Data

```{r}
data = read.csv("all-semi-unique.csv")
dim(data)
names(data)
str(data)
summary(data)
```

Having a look on the first few rows of the data.

```{r}
head(data)
```

## Cleaning Data

### Processing Columns

Removing advertisements columns.

```{r}
data <- data %>% select(-starts_with("ad."))
ncol(data)
names(data)
```

Removing road images, colors and rode report images.

```{r}
data <- subset(data, select = -c(rd.img, rd.cl, rd.rp.rpImg, rd.rp.img))
ncol(data)
names(data)
```

### Processing Rows

Checking number of duplicate rows.

```{r}
nrow(data) - nrow(unique(data))
```

Removing rows with same comment id.

```{r}
data <- data %>% distinct(rd.rp.cmid)
nrow(data)
```

## Feature Engineering

Checking proportion of N/A values.

```{r}
sum(is.na(data)) / nrow(data) / ncol(data)

barplot(sapply(data, function(col) sum(is.na(col))))
```

### Feature Removal

Checking columns with constant features and printing their names.

```{r}
col_ct = sapply(data, function(x) length(unique(x)))
length(col_ct[col_ct == 1])
names(col_ct[col_ct == 1])
```

Removing constant-feature columns.

```{r}
data = data[, !names(data) %in% names(col_ct[col_ct == 1])]
ncol(data)
names(data)
```

### Feature Creation

Formatting `crawl_date` into a proper `datetime` format and changing the timezone from `UTC` to `Egypt`.

```{r}
data$formatted_crawl_date <- as.POSIXct(data$crawl_date, format = "%a %b %d %T UTC %Y", tz = "UTC")
data$formatted_crawl_date <- as.POSIXct(c(data$formatted_crawl_date), tz = "Egypt")
head(data$crawl_date)
head(data$formatted_crawl_date)
str(data$formatted_crawl_date)
```

Adding `report_date` to the data frame.

```{r}
data$report_date <- data$formatted_crawl_date - hours(data$rd.rp.hr) - minutes(data$rd.rp.mn)
head(data$report_date)
```

Finding road delimiters.

```{r}
nrow(data) - length(which(grepl(";", data$rd.nm))) - length(which(grepl("-", data$rd.nm))) - length(which(grepl("/", data$rd.nm)))

missed_delimiters <- which(!grepl(";", data$rd.nm) & !grepl("-", data$rd.nm) & !grepl("/", data$rd.nm))

unique(data[missed_delimiters,]$rd.nm)
```

Splitting road names into areas and roads.

```{r}
data <- data %>% mutate(
  area = ifelse(grepl(";", rd.nm),
                str_split_fixed(rd.nm, ";", 2)[, 1],
                ifelse(grepl("-", rd.nm),
                       str_split_fixed(rd.nm, "-", 2)[, 1],
                       ifelse(grepl("/", rd.nm),
                              str_split_fixed(rd.nm, "/", 2)[, 1],
                              rd.nm)))
  
  ,
  
  road = ifelse(grepl(";", rd.nm),
                str_split_fixed(rd.nm, ";", 2)[, 2],
                ifelse(grepl("-", rd.nm),
                       str_split_fixed(rd.nm, "-", 2)[, 2],
                       ifelse(grepl("/", rd.nm),
                              str_split_fixed(rd.nm, "/", 2)[, 2],
                              NA)))
)
```

Getting road directions.

```{r}
data <- data %>% mutate(
  road_from = ifelse(is.na(road), NA, str_split_fixed(road, " To ", 2)[, 1])
  
  ,
  
  road_to = ifelse(is.na(road), NA, str_split_fixed(road, " To ", 2)[, 2])
)
```